node('master') {
    stage('unit-tests') {

        //checkout([$class: 'GitSCM', branches: [[name: '$GERRIT_BRANCH']],
        //    userRemoteConfigs: [[url: 'ssh://git@gitlab.xlab.si:13022/dice/BigData-Transport.git']], refspec: '$GERRIT_REFSPEC',
        //    credentialId: 'jenkins'])
        // Checkout the Gerrit git repository
        git url: 'ssh://jenkins@172.16.93.151:29418/BigData-Transport',
            credentialId: 'jenkins'

        // Fetch the changeset to a local branch using the build parameters
        // provided to the build by the Gerrit plugin...
        def changeBranch = "change-${GERRIT_CHANGE_NUMBER}-${GERRIT_PATCHSET_NUMBER}"
        sh "git fetch origin ${GERRIT_REFSPEC}:${changeBranch}"
        sh "git checkout ${changeBranch}"

        sh '''
            if [ ! -d "../venv" ]
            then
              virtualenv -p python3 ../venv
            fi
        '''
        sh '''
            PATH="$WORKSPACE/../venv/bin":/usr/local/bin:$PATH
            . "$WORKSPACE/../venv/bin/activate"
            cd python_package
            pip install .
            python -m unittest discover
        '''

        // bundle the workspace in a stash ...
        stash name: 'all-workspace'
    }
}

node('dice_worker') {
    stage('kitchen-tests') {
        // ... and unbundle it at the worker, avoiding network routing issues
        unstash name: 'all-workspace'

        try {
            sh 'bash run-kitchen-tests.sh'
        } catch(err) {
            currentBuild.result = 'FAILURE'
        }
        archiveArtifacts artifacts: 'chef-repository/.kitchen/logs/*'
    }
}